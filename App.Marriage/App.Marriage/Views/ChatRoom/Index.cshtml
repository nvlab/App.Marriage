@using App.Marriage.Utils;
@using App.Marriage.Models.PersonMV;
@using App.Marriage.Models.ChatRoomMessageMV
@model  List<ChatRoomMessageViewModel>
<script src="~/Scripts/JSCallAjax.js"></script>
<link href="~/Content/theme-01/css/chat-style.css" rel="stylesheet" />
<script>
    var $ChatInbox = $('#chatpanels');
    var User_Id = "@ViewBag.SPerson.User_Id";
    var RelationRequest_Id = "@ViewBag.RelationRequest_Id";
    var UserIMG = "@ViewBag.SPerson.Photo1";
    var UserName = "@ViewBag.SPerson.FullName";
    /// Read Last Information 
    
    var LoaderTimer = 1000;

    var ChatLoaderEvent = setTimeout(LoaderNewMessage, LoaderTimer);


    var LastMessageId = "@(Model.Count()>0?@Model.LastOrDefault().Id:0)";


  


    function LoaderNewMessage() {
        var url = '@Url.Action("LoadChatRoomMessages","ChatRoom")';
        var param = GeneratePameter([["LastMessage", LastMessageId], ["RelationRequest_Id", RelationRequest_Id], ["User_Id", User_Id]]);
        $.ajax({
            type: 'POST',
            url: url +param,
            async: false,
            success: function (data) {
                if (data.length > 0) {
                    LoadMessagesIntoChatBox(data);
                }

            }
        });

        ChatLoaderEvent = setTimeout(LoaderNewMessage, LoaderTimer);
    };

    function LoadMessagesIntoChatBox(data) {
        for (i = 0; i < data.length; i++)
        {
            WriteUserMesageIntoChatBox(data[i].IMG, data[i].Message, data[i].IMG, data[i].SenderFullName);
            LastMessageId = data[i].Id;
        }

    };

    function handle(e) {
        if (e.keyCode === 13) {
            e.preventDefault(); // Ensure it is only this code that rusn

            SendMessage();
        }
    }

    function SendMessage() {
        var url = '@Url.Action("SendMsgRequest", "ChatRoom")';
        var param = GeneratePameter([["Msg", $("#Msg").val()], ["User_Id", User_Id], ["RelationRequest_Id", RelationRequest_Id]]);
        WriteUserMesageIntoChatBox(true, $("#Msg").val(), UserIMG, UserName);
        $.ajax({
            type: 'POST',
            url: url + param,
            async: false,
            success: function (data) {
                LoaderNewMessage();
            }
        });


        $("#Msg").val(' ');


    };


    function WriteUserMesageIntoChatBox(IsSender, Msg, IMG, FullName) {
        var result;
        if (IsSender) {
            result = ' <div class="chat-box-left">'+Msg+
                              '  </div>'+
                            '    <div class="chat-box-name-left">'+
                                   ' <img src="/Upload/Images/'+IMG+'" alt="'+FullName+'" class="img-circle" />'+FullName+
                           '     </div>'+
                            '    <hr class="hr-clas" />';



        } else {
            result = ' <div class="chat-box-right">'+Msg+
                             '  </div>'+
                           '    <div class="chat-box-name-right">'+
                                  ' <img src="/Upload/Images/'+IMG+'" alt="'+FullName+'" class="img-circle" />'+FullName+
                          '     </div>'+
                           '    <hr class="hr-clas" />';
        }

        $("#chatpanels").append(result).html();
        $("#chatpanels").scrollTop('1E10');
    };





</script>
<div class="container">

    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="col-lg-offset-1 col-sm-5">@Globalization.App_Manager <span class="label label-info">@ViewBag.ResposibleName</span> </h3>

            <h3 class="col-lg-offset-1 col-sm-5">@Globalization.ManagerPhone <span class="label label-info">@ViewBag.ResponsiblePhone</span> </h3>
        </div>
        <div class="panel-body">
            <section id="couple" class="section-couple">

                <div class="flowers"></div>
                <h2>@Globalization.ChatRoom</h2>
                <div class="section-intro">
                    <p>@Globalization.ChatRoomInfo</p>
                </div>
                <div class="bride-and-groom flex-responsive">
                    <div class="groom">
                        <div class="profile-pic animation-chain" data-animation="fadeInUp">
                            <img src="~/Upload/Images/img1.jpg" width="350px" alt="">
                        </div>
                        <h3>@ViewBag.SPerson.FullName</h3>
                        <h4>التفاصيل</h4>
                        <p>
                            @ViewBag.SPerson.GeneralInfo
                        </p>
                    </div>
                    <div class="bride">
                        <div class="profile-pic animation-chain" data-animation="fadeInUp">
                            <img src="~/Upload/Images/img1.jpg" width="350px" alt="" class="img-circle">
                        </div>
                        <h3>@ViewBag.TPerson.FullName</h3>
                        <h4>التفاصيل</h4>
                        <p>
                            @ViewBag.TPerson.GeneralInfo
                        </p>
                    </div>

                </div>
            </section>

        </div>
    </div>

    <div class="row pad-top pad-bottom">
        <div class="col-lg-12 col-md-12 col-sm-12">
            <div class="chat-box-div">
                <div class="chat-box-head">
                    المحادثات الشخصية
                    <div class="btn-group pull-right">
                        <button type="button" class="btn btn-info dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                            <span class="fa fa-cogs"></span>
                            <span class="sr-only">Toggle Dropdown</span>
                        </button>
                        <ul class="dropdown-menu" role="menu">
                            <li><a href="#"><span class="fa fa-map-marker"></span>&nbsp;Invisible</a></li>
                            <li><a href="#"><span class="fa fa-comments-o"></span>&nbsp;Online</a></li>
                            <li><a href="#"><span class="fa fa-lock"></span>&nbsp;Busy</a></li>
                            <li class="divider"></li>
                            <li><a href="#"><span class="fa fa-circle-o-notch"></span>&nbsp;Logout</a></li>
                        </ul>
                    </div>
                </div>
                <div id="chatpanels" class="panel-body chat-box-main">
                    @{
                        foreach (ChatRoomMessageViewModel Msg in Model)
                        {
                            if(Msg.IsUserMsgSender)
                            {
                                <div class="chat-box-left">
                                   @Msg.Message
                                </div>
                                <div class="chat-box-name-left">
                                    <img src="~/Upload/Images/@Msg.IMG" alt="@Msg.SenderFullName" class="img-circle" />
                                      @Msg.SenderFullName
                                </div>
                                <hr class="hr-clas" />
                            }
                            else
                            {
                                <div class="chat-box-right">
                                    @Msg.Message
                                </div>
                                <div class="chat-box-name-right">
                                    <img src="~/Upload/Images/@Msg.IMG" alt="@Msg.SenderFullName" class="img-circle" />
                                    @Msg.SenderFullName
                                </div>
                                <hr class="hr-clas" />
                            }
                        }
                    }
                </div>
                <div class="chat-box-footer">
                    <div class="input-group">
                        <input id="Msg" type="text" class="form-control" placeholder="Enter Text Here..." onkeypress="handle(event)">
                        <span class="input-group-btn">
                            <button id="SendMsg" class="btn btn-info" type="button" onclick="SendMessage()">SEND</button>
                        </span>
                    </div>
                </div>

            </div>

        </div>


    </div>
</div>

<script>
    $(document).ready(function () { $("#chatpanels").scrollTop('1E10'); });
    
</script>